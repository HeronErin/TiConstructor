\doxysection{interupts.\+c}
\hypertarget{interupts_8c_source}{}\label{interupts_8c_source}\index{lib/interupts.c@{lib/interupts.c}}
\mbox{\hyperlink{interupts_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#define\ \_\_hs\ \#}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#define\ INTRPT\_MASK\ \ 0b00001011}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#define\ basepage\ 0x8584}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#define\ SET\_INTERUPTS()\ \ \ \ \ \_\_asm\(\backslash\)}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ ld\ de,\ \_\_hs\ \ (ON\_EXIT-\/LoadInterrupt+0x8E2C)\ \(\backslash\)}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ push\ de\ \(\backslash\)}}
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\ \ \ \ \_\_endasm;\ \_\_\_\_\_\_\_\_\_SET\_INTERUPTS();\ \_\_asm\(\backslash\)}}
\DoxyCodeLine{00047\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ ld\ \ ix,\_\_hs\ 0\(\backslash\)}}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ add\ ix,sp\(\backslash\)}}
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\ \ \ \ \_\_endasm;}}
\DoxyCodeLine{00050\ \ \ \ \ }
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00056\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{interupts_8c_a541352fa8faca369352a59691f4d7261}{\_\_\_\_\_\_\_\_\_SET\_INTERUPTS}}()\{}
\DoxyCodeLine{00057\ \ \ \ \ \_\_asm}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ ;\ disable\ interrupts\ and\ set\ interrupt\ mode\ 2}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ di}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \ im\ 2}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ ;\ save\ whichever\ page\ we\ are\ on\ so\ that\ we\ know\ where\ to\ go}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ in\ a,(6)}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ ld\ (\mbox{\hyperlink{interupts_8c_a1f71a76a10c4c9dde3696a69083045f0}{basepage}}),a}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ ;\ set\ the\ upper\ \textcolor{keywordtype}{byte}\ of\ the\ jumptable\ to\ \$80}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ ld\ a,\#0x80}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ ld\ i,a}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ ;\ now\ we\ copy\ our\ interrupt\ loader\ to\ ram,\ we\ only\ have\ to\ \textcolor{keywordflow}{do}\ \textcolor{keyword}{this}\ once}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \ ld\ hl,\#LoadInterrupt}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ A\ better\ place\ to\ store\ the\ rom\ loader\ code}}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \ ld\ de,\ \#0x8E2C\ }
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ ld\ bc,\#EndLoadInterupt-\/LoadInterrupt}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ ldir}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ ;\ create\ the\ vector\ table\ (\textcolor{keywordflow}{do}\ \textcolor{keyword}{this}\ every\ time\ before\ you\ enable\ interrupts,\ be\ sure\ to\ disable\ interrupts\ before\ archiving\ /\ unarchiving\ stuff)}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ ld\ hl,\ \#0x8000}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ ld\ de,\ \#0x8001}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ ld\ (hl),\ \#0x85}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ ld\ bc,\#256}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ ldir}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ ;\ setting\ up\ the\ jump\ handler\ at\ \$8585}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ ld\ hl,\#0x8585}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ ld\ (hl),\#0xc3\ ;\ \textcolor{keyword}{this}\ is\ the\ jp\ instruction}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ ld\ de,\#0x8E2C\ ;\ where\ it\ jumps\ to}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ inc\ hl}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ ld\ (hl),e}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ inc\ hl}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ ld\ (hl),d}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ ;\ time\ to\ enable\ interrupts}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ ei}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \_\_endasm;}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00102\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{interupts_8c_a6186bb2f266a45dadb0c9e5cfcd4b6a2}{\_\_\_\_\_copied\_to\_position}}()\_\_naked\{}
\DoxyCodeLine{00103\ \ \ \ \ }
\DoxyCodeLine{00104\ \ \ \ \ \_\_asm}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ LoadInterrupt:}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ di}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ exx}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{essentials_8c_a2729ab5166820ef85f4c3a4a50c49c8e}{aSaveA}}}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ xor\ a,\ a}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ out\ (3),a}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#ifdef\ FLASH\_APP}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ in\ a,(6)}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ push\ af}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ ld\ a,(\mbox{\hyperlink{interupts_8c_a1f71a76a10c4c9dde3696a69083045f0}{basepage}})}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ out\ (6),a}
\DoxyCodeLine{00119\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \_\_endasm;}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ DURING\_INTERUPT();}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \_\_asm}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00126\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#ifdef\ FLASH\_APP}}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ pop\ af}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ out\ (6),a}
\DoxyCodeLine{00129\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ xor\ a,\ \#\mbox{\hyperlink{interupts_8c_a09e68d8e9da5272f666f766a4915875f}{INTRPT\_MASK}}}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ out\ (3),a}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{essentials_8c_a2729ab5166820ef85f4c3a4a50c49c8e}{aSaveA}}}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ exx}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ ei}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ ret}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ ON\_EXIT:\ \ }
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \ \ \ \ di}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ im\ 1\ }
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \ \ ld\ a,\ \mbox{\hyperlink{interupts_8c_a080021f8b22b47e0e515fadb3342b6d8}{\_\_hs}}\ \mbox{\hyperlink{interupts_8c_a09e68d8e9da5272f666f766a4915875f}{INTRPT\_MASK}}\ }
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ out\ (3),\ a}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ useful\ for\ greyscale}}
\DoxyCodeLine{00148\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ ADDED\_ON\_EXIT}}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \_\_endasm;}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ ADDED\_ON\_EXIT();}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \_\_asm}
\DoxyCodeLine{00152\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ ei\ }
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ ret\ }
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ EndLoadInterupt:}
\DoxyCodeLine{00159\ \ \ \ \ \_\_endasm;}
\DoxyCodeLine{00160\ \}}

\end{DoxyCode}
