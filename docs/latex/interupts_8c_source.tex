\doxysection{interupts.\+c}
\hypertarget{interupts_8c_source}{}\label{interupts_8c_source}\index{lib/interupts.c@{lib/interupts.c}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Taken\ from\ https://www.omnimaga.org/asm-\/language/interrupt-\/routine-\/not-\/returning/msg404756/\#msg404756}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ With\ interupts\ im\ not\ quite\ sure\ what\ im\ doing\ but\ this\ interupt\ system\ work}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{comment}{//\ See\ https://taricorp.gitlab.io/83pa28d/lesson/day23.html\ and\ https://wikiti.brandonw.net/index.php?title=83Plus:Ports:03}}
\DoxyCodeLine{00008\ \textcolor{comment}{//\ interupts\ "{}interupt"{}\ your\ code\ on\ run\ something\ else}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{comment}{//\ They\ must\ run\ fast,\ I\ recomend\ you\ only\ run\ asm}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ The\ absolute\ max\ is\ 54545\ t-\/states,\ just\ remember\ an\ interupt\ is\ ran}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ more\ then\ 100\ times\ per\ secound\ and\ the\ z80\ only\ has\ 1\ core}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{comment}{//\ before\ including\ this\ file,\ run:\ \#define\ DURING\_INTERUPT()\ YOUR\_CODE\_HERE}}
\DoxyCodeLine{00017\ \textcolor{comment}{//\ Never\ run\ anything\ here\ except\ SET\_INTERUPTS,\ in\ this\ project\ assume\ if\ something\ starts\ with\ ten\ underscores,\ don't\ try\ to\ run\ it}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#define\ \_\_hs\ \#\ }\textcolor{comment}{//\ bypass\ rule\ against\ using\ \#\ in\ macros}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#define\ INTRPT\_MASK\ \ 0b00001011\ }\textcolor{comment}{//\ Use\ all\ interupts}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#define\ basepage\ 0x8584}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#define\ SET\_INTERUPTS()\ \ \ \ \ \_\_asm\(\backslash\)}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ ld\ de,\ \_\_hs\ \ (ON\_EXIT-\/LoadInterrupt+0x8E2C)\ \(\backslash\)}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ push\ de\ \(\backslash\)}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\ \ \ \ \_\_endasm;\ \_\_\_\_\_\_\_\_\_SET\_INTERUPTS();\ \_\_asm\(\backslash\)}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ ld\ \ ix,\_\_hs\ 0\(\backslash\)}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ add\ ix,sp\(\backslash\)}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\ \ \ \ \_\_endasm;}}
\DoxyCodeLine{00035\ \ \ \ \ }
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \textcolor{comment}{//\ Start\ the\ stuff\ i\ took}}
\DoxyCodeLine{00041\ \textcolor{keywordtype}{void}\ \_\_\_\_\_\_\_\_\_SET\_INTERUPTS()\{}
\DoxyCodeLine{00042\ \ \ \ \ \_\_asm}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \ ;\ disable\ interrupts\ and\ set\ interrupt\ mode\ 2}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ di}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ im\ 2}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ ;\ save\ whichever\ page\ we\ are\ on\ so\ that\ we\ know\ where\ to\ go}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ in\ a,(6)}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ ld\ (basepage),a}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ ;\ set\ the\ upper\ \textcolor{keywordtype}{byte}\ of\ the\ jumptable\ to\ \$80}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \ ld\ a,\#0x80}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \ ld\ i,a}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \ ;\ now\ we\ copy\ our\ interrupt\ loader\ to\ ram,\ we\ only\ have\ to\ \textcolor{keywordflow}{do}\ \textcolor{keyword}{this}\ once}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \ ld\ hl,\#LoadInterrupt}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ A\ better\ place\ to\ store\ the\ rom\ loader\ code}}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ ld\ de,\ \#0x8E2C\ }
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \ ld\ bc,\#EndLoadInterupt-\/LoadInterrupt}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ ldir}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ ;\ create\ the\ vector\ table\ (\textcolor{keywordflow}{do}\ \textcolor{keyword}{this}\ every\ time\ before\ you\ enable\ interrupts,\ be\ sure\ to\ disable\ interrupts\ before\ archiving\ /\ unarchiving\ stuff)}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ ld\ hl,\ \#0x8000}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ ld\ de,\ \#0x8001}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ ld\ (hl),\ \#0x85}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ ld\ bc,\#256}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ ldir}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ ;\ setting\ up\ the\ jump\ handler\ at\ \$8585}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \ ld\ hl,\#0x8585}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ ld\ (hl),\#0xc3\ ;\ \textcolor{keyword}{this}\ is\ the\ jp\ instruction}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ ld\ de,\#0x8E2C\ ;\ where\ it\ jumps\ to}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \ inc\ hl}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ ld\ (hl),e}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ inc\ hl}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ ld\ (hl),d}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ ;\ time\ to\ enable\ interrupts}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ ei}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \_\_endasm;}
\DoxyCodeLine{00084\ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \textcolor{keywordtype}{void}\ \_\_\_\_\_copied\_to\_position()\_\_naked\{}
\DoxyCodeLine{00087\ \ \ \ \ }
\DoxyCodeLine{00088\ \ \ \ \ \_\_asm}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ LoadInterrupt:}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ di}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ exx}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ aSaveA}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ xor\ a,\ a}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ out\ (3),a}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#ifdef\ FLASH\_APP}}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ in\ a,(6)}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ push\ af}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ ld\ a,(basepage)}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ out\ (6),a}
\DoxyCodeLine{00103\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \_\_endasm;}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ DURING\_INTERUPT();}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \_\_asm}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00110\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#ifdef\ FLASH\_APP}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ pop\ af}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ out\ (6),a}
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ xor\ a,\ \#INTRPT\_MASK}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ out\ (3),a}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ aSaveA}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ exx}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ ei}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ ret}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ ON\_EXIT:\ \ }
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ di}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ im\ 1\ }
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ ld\ a,\ \_\_hs\ INTRPT\_MASK\ }
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ out\ (3),\ a}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ useful\ for\ greyscale}}
\DoxyCodeLine{00132\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ ADDED\_ON\_EXIT}}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \_\_endasm;}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ ADDED\_ON\_EXIT();}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \_\_asm}
\DoxyCodeLine{00136\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ ei\ }
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \ \ ret\ }
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ EndLoadInterupt:}
\DoxyCodeLine{00143\ \ \ \ \ \_\_endasm;}
\DoxyCodeLine{00144\ \}}

\end{DoxyCode}
